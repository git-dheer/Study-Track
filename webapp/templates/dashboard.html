{% extends 'base.html' %}
{% block content %}
  
  <script> document.page_id = 'dashboard'; </script>

  <div class="mb-6">
    <h1 class="text-3xl font-semibold">Dashboard</h1>
    <p class="muted">Welcome to your local StudyTrack.</p>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

    <div class="lg:col-span-2 space-y-6">
      
      <div class="card p-6 rounded-lg shadow-sm">
        <h2 class="text-lg font-medium mb-3">Current Status</h2>
        <div id="statusWidget">
          <p class="muted">Loading status...</p>
        </div>
      </div>

      <div class="card p-6 rounded-lg shadow-sm">
        <h2 class="text-lg font-medium mb-4">30-Day Focus (Hours)</h2>
        <div class="h-80"> <canvas id="weeklyChart"></canvas>
        </div>
      </div>

    </div>

    <div class="lg:col-span-1 space-y-6">

      <div class="card card-gradient-purple p-6 rounded-lg shadow-sm">
        <h2 class="text-lg font-medium mb-3 text-white opacity-90">Today's Focus</h2>
        <div class="text-4xl font-bold" id="stats-today">--:--:--</div>
        <p id="stats-today-placeholder" class="text-white opacity-70 text-sm mt-4">Stats API coming soon...</p>
      </div>

      <div class="card p-6 rounded-lg shadow-sm">
        <h2 class="text-lg font-medium mb-3">Recent Sessions</h2>
        <div id="sessionsList" class="space-y-3 muted max-h-96 overflow-y-auto">
          Loading...
        </div>
      </div>

    </div>
  </div>
  <script>
// --- 1. HELPER FUNCTIONS (DEFINED FIRST) ---
function secToHHMMSS(s){
  let h = Math.floor(s/3600); s %= 3600;
  let m = Math.floor(s/60); let sec = s%60;
  return `${h}h ${String(m).padStart(2,'0')}m ${String(sec).padStart(2,'0')}s`;
}

function escapeHtml(unsafe){ 
  return unsafe.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); 
}

async function deleteSession(sessionId, event) {
  event.stopPropagation();
  event.preventDefault();
  if (!confirm('Are you sure you want to permanently delete this session?')) {
    return;
  }
  try {
    const res = await fetch('/api/session/delete', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({session_id: sessionId})
    });
    const data = await res.json();
    if (data.success) {
      document.getElementById(`session-card-${sessionId}`).remove();
    } else {
      alert('Failed to delete session: ' + data.error);
    }
  } catch (err) {
    alert('An error occurred: ' + err);
  }
}

// --- 2. WIDGET-LOADING FUNCTIONS ---

async function refreshSessions(){ 
  const res = await fetch('/api/all_sessions'); 
  if (!res.ok) {
      document.getElementById('sessionsList').innerHTML = '<div class="text-red-400">Error: Could not load recent sessions.</div>';
      return;
  }
  
  const data = await res.json(); 
  const el = document.getElementById('sessionsList'); 
  if (!data.sessions || data.sessions.length===0){ 
    el.innerHTML = '<div class="muted">No sessions yet.</div>'; 
    return; 
  } 
  
  el.innerHTML=''; 
  
  data.sessions.slice(0, 5).forEach(s=>{ // Show 5 most recent
    const start = new Date(s.start_ts*1000); 
    const endTxt = s.end_ts ? (' — '+new Date(s.end_ts*1000).toLocaleString()) : ' — <b class="text-green-400">Running</b>';
    const dur = s.end_ts ? s.duration : '-';
    
    const node = document.createElement('div');
    node.id = `session-card-${s.id}`;
    node.className = 'flex justify-between items-center p-3 rounded bg-gray-900 border border-gray-800 hover:border-cyan-500 transition-colors group';
    
    const link = document.createElement('a');
    link.href = `/session/${s.id}/summary`;
    link.className = 'flex-grow';
    link.innerHTML = '<div class="font-medium">' + escapeHtml(s.name) + '</div>'
      + '<div class="muted text-sm">' + escapeHtml(s.tags || 'No tags') + ' · '
      + start.toLocaleString() + endTxt + ' · ' + dur + '</div>';
    
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'px-2 py-1 rounded bg-red-800 hover:bg-red-700 text-red-200 opacity-0 group-hover:opacity-100 transition-opacity ml-4';
    deleteBtn.innerHTML = '<i data-feather="trash-2" class="w-4 h-4"></i>';
    deleteBtn.onclick = (e) => deleteSession(s.id, e);
    
    node.appendChild(link);
    node.appendChild(deleteBtn);
    el.appendChild(node);
  }); 
  
  feather.replace();
}

let statusInterval = null;
async function refreshStatus() {
  try {
    const res = await fetch('/api/status');
    const data = await res.json();
    const el = document.getElementById('statusWidget');
    
    if (data.running) {
      let statusText = data.status === 'paused' 
        ? '<span class="text-yellow-400 font-medium">Paused</span>'
        : '<span class="text-green-400 font-medium">Running</span>';
        
      el.innerHTML = `
        <div class="font-medium text-lg">${escapeHtml(data.session.name)}</div>
        <div class="muted text-sm mb-3">${escapeHtml(data.session.tags || 'No tags')}</div>
        <div class="font-mono text-3xl font-bold mb-3">${data.elapsed_str}</div>
        <div class="flex items-center justify-between">
          ${statusText}
          <a href="/timers" class="px-3 py-1 rounded bg-cyan-600 hover:bg-cyan-500 text-sm font-medium">
            Go to Timer &rarr;
          </a>
        </div>
      `;
      if (data.status === 'running' && !statusInterval) {
        statusInterval = setInterval(refreshStatus, 1000);
      } else if (data.status === 'paused' && statusInterval) {
        clearInterval(statusInterval);
        statusInterval = null;
      }
    } else {
      if (statusInterval) clearInterval(statusInterval);
      statusInterval = null;
      el.innerHTML = `
        <p class="muted mb-4">No session is currently running.</p>
        <a href="/timers" class="px-4 py-2 rounded bg-green-600 hover:bg-green-500 font-medium">
          Start a New Session
        </a>
      `;
    }
  } catch (err) {
    document.getElementById('statusWidget').innerHTML = '<div class="text-red-400">Error loading status.</div>';
  }
}

// THIS IS THE WORKING FUNCTION THAT USES /api/dashboard_stats
async function loadDashboardStats() {
  try {
    // 1. Call our new, simple API endpoint
    const res = await fetch('/api/dashboard_stats'); 
    const data = await res.json();
    
    if (!data.success) { 
      throw new Error('Failed to load dashboard stats'); 
    }

    // 2. Populate "Today's Focus" Card
    if (data.todays_focus_str) {
      document.getElementById('stats-today').textContent = data.todays_focus_str;
      document.getElementById('stats-today-placeholder').style.display = 'none';
    } else {
      document.getElementById('stats-today').textContent = "0h 00m 00s";
    }
    
    // 3. Check for 'daily_trend' data for the chart
    if (!data.daily_trend || !data.daily_trend.data) { 
      throw new Error('Failed to load chart data (missing daily_trend)');
    }
    
    // 4. Get the correct labels and data
    const labels = data.daily_trend.labels;
    const chartData = data.daily_trend.data;

    const ctx = document.getElementById('weeklyChart').getContext('2d');
    
    // 5. Draw the chart
    const gradient = ctx.createLinearGradient(0, 0, 0, 300);
    gradient.addColorStop(0, 'rgba(56, 189, 248, 0.5)');
    gradient.addColorStop(1, 'rgba(56, 189, 248, 0)');

    new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Focus Hours',
          data: chartData,
          backgroundColor: gradient,
          borderColor: '#38bdf8',
          borderWidth: 2,
          pointBackgroundColor: '#fff',
          pointBorderColor: '#38bdf8',
          pointHoverRadius: 6,
          pointRadius: 4,
          tension: 0.3,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: { beginAtZero: true, grid: { color: '#374151' }, ticks: { color: '#9ca3af' } },
          x: { grid: { display: false }, ticks: { color: '#9ca3af' } }
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: '#1f2937',
            titleFont: { size: 14 },
            bodyFont: { size: 12 },
            padding: 10,
            caretSize: 6,
            cornerRadius: 6,
            callbacks: {
              label: function(context) { return ` ${context.parsed.y} hours`; }
            }
          }
        }
      }
    });

  } catch (err) {
    console.error("Error in loadDashboardStats:", err);
    document.getElementById('weeklyChart').parentElement.innerHTML = '<div class="text-red-400">Error: Could not load chart.</div>';
  }
}

// --- 3. RUN ALL FUNCTIONS ---
refreshSessions();
refreshStatus();
loadDashboardStats(); 
</script>

{% endblock %}