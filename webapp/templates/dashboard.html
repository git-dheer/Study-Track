{% extends 'base.html' %}
{% block content %}
  
  <script> document.page_id = 'dashboard'; </script>

  <div class="mb-6">
    <h1 class="text-3xl font-semibold">Dashboard</h1>
    <p class="muted">Welcome to your local StudyTrack.</p>
  </div>

  <div class="card p-6 rounded-lg shadow-sm">
    <h2 class="text-lg font-medium mb-3">Recent sessions</h2>
    <div id="sessionsList" class="space-y-3 muted">Loading...</div>
  </div>

<script>
// --- THIS FUNCTION WAS MISSING (but is not the cause of the crash) ---
function secToHHMMSS(s){
  let h = Math.floor(s/3600); s %= 3600;
  let m = Math.floor(s/60); let sec = s%60;
  return `${h}h ${String(m).padStart(2,'0')}m ${String(sec).padStart(2,'0')}s`;
}

function escapeHtml(unsafe){ 
  return unsafe.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); 
}

async function refreshSessions(){ 
  const res = await fetch('/api/recent'); 
  // Handle server errors (like the one we just saw)
  if (!res.ok) {
      document.getElementById('sessionsList').innerHTML = '<div class="text-red-400">Error: Could not load recent sessions.</div>';
      return;
  }
  
  const data = await res.json(); 
  const el = document.getElementById('sessionsList'); 
  if (!data.sessions || data.sessions.length===0){ 
    el.innerHTML = '<div class="muted">No sessions yet.</div>'; 
    return; 
  } 
  el.innerHTML=''; 
  data.sessions.forEach(s=>{ 
    const start = new Date(s.start_ts*1000); 
    const endTxt = s.end_ts ? (' — '+new Date(s.end_ts*1000).toLocaleString()) : ' — <b class="text-green-400">Running</b>';
    const dur = s.end_ts ? s.duration : '-'; // s.duration is already formatted by the API
    
    const node = document.createElement('a');
    node.href = `/session/${s.id}/summary`; 
    node.className='block p-3 rounded bg-gray-900 border border-gray-800 hover:border-cyan-500 transition-colors'; 
    node.innerHTML='<div class="font-medium">'+escapeHtml(s.name)+'</div>'
      +'<div class="muted text-sm">'+escapeHtml(s.tags||'No tags')+' · '
      +start.toLocaleString()+endTxt+' · '+dur+'</div>'; 
      
    el.appendChild(node); 
  }); 
}

// Load the sessions when the page opens
refreshSessions();

</script>

{% endblock %}